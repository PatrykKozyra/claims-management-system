{% extends 'claims/base.html' %}

{% block title %}Create New User - Claims Management System{% endblock %}

{% block content %}
<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span id="errorToastMessage">An error occurred</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-person-plus"></i> Create New User Account</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'user_directory' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to User Directory
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="post" id="userCreateForm" autocomplete="off">
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Account Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.username.id_for_label }}">
                            Username <span class="text-danger">*</span>
                        </label>
                        {{ form.username }}
                        {% if form.username.help_text %}
                        <small class="form-text text-muted">{{ form.username.help_text }}</small>
                        {% endif %}
                        {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.first_name.id_for_label }}">
                                First Name <span class="text-danger">*</span>
                            </label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                            <div class="text-danger">{{ form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.last_name.id_for_label }}">
                                Last Name <span class="text-danger">*</span>
                            </label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                            <div class="text-danger">{{ form.last_name.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="{{ form.email.id_for_label }}">
                            Email Address <span class="text-danger">*</span>
                        </label>
                        {{ form.email }}
                        {% if form.email.help_text %}
                        <small class="form-text text-muted">{{ form.email.help_text }}</small>
                        {% endif %}
                        {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.position.id_for_label }}">
                                Position/Job Title
                            </label>
                            {{ form.position }}
                            {% if form.position.errors %}
                            <div class="text-danger">{{ form.position.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.department.id_for_label }}">
                                Department
                            </label>
                            {{ form.department }}
                            {% if form.department.errors %}
                            <div class="text-danger">{{ form.department.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Security & Permissions</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>First Login:</strong> The user will be required to change this temporary password when they first log in.
                    </div>

                    <!-- Password Generator Display -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-key"></i> Password Generator
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="generatedPasswordDisplay" placeholder="Click 'Generate Password' to create a secure password" readonly>
                            <button type="button" class="btn btn-outline-secondary" id="generatePasswordBtn">
                                <i class="bi bi-arrow-repeat"></i> Generate Password
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="quickCopyBtn" style="display: none;">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <small class="form-text text-muted">Generated password will be visible here. Click 'Copy' to copy it to clipboard.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.password1.id_for_label }}">
                                Temporary Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.password1 }}
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                                    <i class="bi bi-eye" id="toggleIcon1"></i>
                                </button>
                            </div>
                            {% if form.password1.help_text %}
                            <small class="form-text text-muted">{{ form.password1.help_text }}</small>
                            {% endif %}
                            {% if form.password1.errors %}
                            <div class="text-danger">{{ form.password1.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="{{ form.password2.id_for_label }}">
                                Confirm Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.password2 }}
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                                    <i class="bi bi-eye" id="toggleIcon2"></i>
                                </button>
                            </div>
                            {% if form.password2.help_text %}
                            <small class="form-text text-muted">{{ form.password2.help_text }}</small>
                            {% endif %}
                            {% if form.password2.errors %}
                            <div class="text-danger">{{ form.password2.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-success" id="fillPasswordsBtn" style="display: none;">
                            <i class="bi bi-arrow-down-circle"></i> Fill Password Fields
                        </button>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label" for="{{ form.role.id_for_label }}">
                            Role / Permission Level <span class="text-danger">*</span>
                        </label>
                        {{ form.role }}
                        {% if form.role.help_text %}
                        <small class="form-text text-muted">{{ form.role.help_text }}</small>
                        {% endif %}
                        {% if form.role.errors %}
                        <div class="text-danger">{{ form.role.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-check2-square"></i> Additional Permissions (Optional)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle"></i> Select additional specific permissions for this user. Most permissions are automatically granted based on the selected role above.
                    </div>

                    {% if form.permissions.help_text %}
                    <small class="form-text text-muted d-block mb-3">{{ form.permissions.help_text }}</small>
                    {% endif %}

                    <div class="row">
                        {% for permission in form.permissions %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                {{ permission.tag }}
                                <label class="form-check-label" for="{{ permission.id_for_label }}">
                                    {{ permission.choice_label }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if form.permissions.errors %}
                    <div class="text-danger mt-2">{{ form.permissions.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="{% url 'user_directory' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Create User Account
                </button>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Role Descriptions</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-primary">Read Only</h6>
                    <p class="small">Can view claims and voyages but cannot make changes.</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary">Read + Export</h6>
                    <p class="small">Can view and export data to Excel but cannot edit.</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary">Write</h6>
                    <p class="small">Can create and edit claims. Can be assigned voyages and claims.</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary">Team Lead</h6>
                    <p class="small">Can assign voyages to analysts and manage team workload.</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary">Administrator</h6>
                    <p class="small">Full system access including user management and all administrative functions.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Password Requirements</h5>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Minimum 8 characters</li>
                    <li>At least 1 uppercase letter</li>
                    <li>At least 1 digit</li>
                    <li>At least 1 special character (!@#$%^&*)</li>
                </ul>
                <div class="alert alert-warning mt-3 mb-0">
                    <strong>Note:</strong> The user will be forced to change this password on first login.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Password generator function
function generateSecurePassword() {
    const length = 12;
    const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lowercase = 'abcdefghijklmnopqrstuvwxyz';
    const numbers = '0123456789';
    const special = '!@#$%^&*';
    const all = uppercase + lowercase + numbers + special;

    let password = '';
    // Ensure at least one of each required type
    password += uppercase[Math.floor(Math.random() * uppercase.length)];
    password += lowercase[Math.floor(Math.random() * lowercase.length)];
    password += numbers[Math.floor(Math.random() * numbers.length)];
    password += special[Math.floor(Math.random() * special.length)];

    // Fill the rest
    for (let i = password.length; i < length; i++) {
        password += all[Math.floor(Math.random() * all.length)];
    }

    // Shuffle the password
    return password.split('').sort(() => Math.random() - 0.5).join('');
}

// Generate password button
document.getElementById('generatePasswordBtn').addEventListener('click', function() {
    const password = generateSecurePassword();

    // Display in the visible text box
    document.getElementById('generatedPasswordDisplay').value = password;

    // Show copy and fill buttons
    document.getElementById('quickCopyBtn').style.display = 'inline-block';
    document.getElementById('fillPasswordsBtn').style.display = 'inline-block';

    // Visual feedback
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="bi bi-check-circle text-success"></i> Generated!';
    setTimeout(() => {
        this.innerHTML = originalText;
    }, 2000);
});

// Quick copy button (from visible password display)
document.getElementById('quickCopyBtn').addEventListener('click', function() {
    const password = document.getElementById('generatedPasswordDisplay').value;

    // Copy to clipboard
    navigator.clipboard.writeText(password).then(() => {
        // Visual feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check-circle text-success"></i> Copied!';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        }, 2000);
    }).catch(err => {
        // Show error toast instead of alert
        const errorToastMessage = document.getElementById('errorToastMessage');
        errorToastMessage.textContent = 'Failed to copy password. Please copy it manually.';
        const errorToast = document.getElementById('errorToast');
        const toast = new bootstrap.Toast(errorToast, {
            autohide: true,
            delay: 5000
        });
        toast.show();
    });
});

// Fill password fields button
document.getElementById('fillPasswordsBtn').addEventListener('click', function() {
    const password = document.getElementById('generatedPasswordDisplay').value;

    if (password) {
        document.getElementById('id_password1').value = password;
        document.getElementById('id_password2').value = password;

        // Visual feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check-circle text-success"></i> Filled!';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Fill Password Fields';
        }, 2000);
    }
});

// Toggle password visibility for Password 1
document.getElementById('togglePassword1').addEventListener('click', function() {
    const passwordField = document.getElementById('id_password1');
    const icon = document.getElementById('toggleIcon1');

    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        passwordField.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
});

// Toggle password visibility for Password 2
document.getElementById('togglePassword2').addEventListener('click', function() {
    const passwordField = document.getElementById('id_password2');
    const icon = document.getElementById('toggleIcon2');

    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        passwordField.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
});
</script>
{% endblock %}
